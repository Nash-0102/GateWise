<% layout('layouts/layout') %>
<% locals.title = 'Maintenance Bills' %>

<div class="max-w-6xl mx-auto py-8 px-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-800">Maintenance Bills</h1>
    <% if (currUser && currUser.role === 'Secretary') { %>
      <a href="/maintains/new" class="px-4 py-2 bg-indigo-600 text-white rounded">Create Bill</a>
    <% } %>
  </div>

  <% if (maintains && maintains.length > 0) { %>
    <% if (currUser.role === 'Secretary') { %>
      <!-- Secretary table -->
      <div class="overflow-x-auto bg-white rounded shadow">
        <table class="w-full text-left">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="p-3">User</th>
              <th class="p-3">House</th>
              <th class="p-3">Title</th>
              <th class="p-3">Amount</th>
              <th class="p-3">Due</th>
              <th class="p-3">Status</th>
              <th class="p-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% maintains.forEach(m => { %>
              <tr class="border-t">
                <td class="p-3"><%= m.user?.profile?.fullName || m.user?.username || 'User' %></td>
                <td class="p-3"><%= m.houseNo %></td>
                <td class="p-3"><%= m.title %></td>
                <td class="p-3">₹<%= m.amount %></td>
                <td class="p-3"><%= new Date(m.dueDate).toLocaleDateString() %></td>
                <td class="p-3"><%= m.status %></td>
                <td class="p-3 text-right">
                  <a href="/maintains/<%= m._id %>" class="text-sm mr-2">View</a>
                  <a href="/maintains/<%= m._id %>/edit" class="text-sm mr-2">Edit</a>
                  <form action="/maintains/<%= m._id %>?_method=DELETE" method="post" class="inline">
                    <button onclick="return confirm('Delete this bill?')" class="text-sm text-rose-600">Delete</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

    <% } else { %>
      <!-- Resident view -->
      <div class="space-y-4">
        <% maintains.forEach(m => { %>
          <div class="bg-white p-4 rounded shadow flex justify-between items-center">
            <div>
              <h3 class="font-semibold text-slate-800"><%= m.title %></h3>
              <p class="text-sm text-slate-500">Due: <%= new Date(m.dueDate).toLocaleDateString() %></p>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold">₹<%= m.amount %></div>
              <div class="text-sm text-slate-500"><%= m.status %></div>
              <div class="mt-2">
                <a href="/maintains/<%= m._id %>" class="px-3 py-1 border rounded">View</a>
                <% if (m.status !== 'paid') { %>
                  <form action="/maintains/<%= m._id %>/pay" method="post" class="inline">
                    <button class="px-3 py-1 ml-2 bg-emerald-500 text-white rounded">Mark Paid</button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>

  <% } else { %>
    <div class="bg-white p-6 rounded shadow text-center">
      <p class="text-slate-600">No maintenance bills found.</p>
    </div>
  <% } %>
</div>
